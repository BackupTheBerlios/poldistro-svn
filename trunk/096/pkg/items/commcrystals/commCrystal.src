use uo;
use basic;

CONST CRYSTALOBJ  := 0xC001;
CONST RECEIVEROBJ := 0xC002;

program use_commCrystal(who, crystal)

	var CrystalStatus := GetObjProperty(crystal, "Status");
	var Charges := GetObjProperty(crystal, "Charges");
	Charges := Cint(Charges);
	if ( Charges <= 0 )
		SendSysMessage(who, "All charges have been used.");
		return 0;
	endif

	var LinkString := GetObjProperty(crystal, "Links");
	var Links := Splitwords(LinkString);
	var LinkCount := Len(Links);
	var CrystalId := crystal.serial;
	var i, blank, placeholder, receiver;
	SendSysMessage(who, "Select object.");
	var TargetItem := target(who);
	if ( (TargetItem.objtype != CRYSTALOBJ) and (TargetItem.objtype != RECEIVEROBJ) )
		SendSysMessage(who, "That is not a communication crystal.");
		return 0;
	endif
	if (TargetItem.serial == crystal.serial)
		if (CrystalStatus == "OFF")
			SendSysMessage(who, "Crystal activated.  You are linked to " + (LinkCount-1) + " receivers.");
			SetObjProperty(crystal, "Status", "ON");
			Charges := Charges -1;
			SetObjProperty( crystal, "Charges", Charges );
			return 0;
		else
			SendSysMessage(who, "Crystal deactivated.");
			SetObjProperty(crystal, "Status", "OFF");
			return 0;
		endif
	endif
	if (TargetItem.objtype == RECEIVEROBJ)
		var Master := GetObjProperty(TargetItem, "Master");
		Master := Cint(Master);
		if (Master == 0)
			If (LinkCount > 10)
				SendSysMessage(who, "Too many receivers.   Aborted.");
				return 0;
			endif
			SendSysMessage(who, "Linked.");
			SetObjProperty(TargetItem, "Master", CrystalId);
			LinkString := Cstr(LinkString) + " " + Cstr(TargetItem.serial);
			SetObjProperty(crystal, "Links", LinkString);
			return 0;
		endif
		if (Master == CrystalId)
			receiver := CStr(TargetItem.serial);
			placeholder := "";
			i := 1;
			LinkCount := LinkCount + 1;
			SetObjProperty(TargetItem, "Master", 0);
			while (i < LinkCount)
				blank := CStr(Links[i]);
				if (blank == receiver)
					blank := "nothing";
					//we ignore this one
				else
					placeholder := placeholder + " " + blank;
				endif
				i := i + 1;
			endwhile
			SetObjProperty(crystal, "Links", placeholder);
			SendSysMessage(who, "Unlinked.");
			return 0;
		else
			SendSysMessage(who, "That receiver is in use.");
			return 0;
		endif
	endif

	return 0;

endprogram
